# 測試指南

Gemini Telegram Bot 的完整手動測試指南。

## 前置條件

### 1. 環境設定

```bash
# 驗證環境變數
cat .env

# 所需的變數：
# - TELEGRAM_BOT_TOKEN
# - TELEGRAM_ALLOWED_USERS
# - GOOGLE_API_KEY
# - GOOGLE_APPLICATION_CREDENTIALS (用於圖片生成)
```

### 2. 安裝相依套件

```bash
# 安裝 Node 相依套件
bun install

# 安裝 Playwright 瀏覽器
npx playwright install chromium

# 驗證 TypeScript 編譯
bun run typecheck
```

### 3. 啟動機器人

```bash
# 在背景啟動機器人
./start.sh

# 驗證機器人正在執行
./status.sh

# 查看日誌
tail -f bot.log
```

## 測試分類

## 1. 身份驗證與授權

### 測試 1.1：授權使用者存取

**步驟：**
1. 從允許的使用者傳送 `/start` 給機器人
2. 傳送 `/help` 命令

**預期結果：**
- 機器人回應歡迎訊息
- 幫助菜單顯示所有可用命令
- 沒有錯誤訊息

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 1.2：未授權使用者存取

**步驟：**
1. 從 NOT 在 `TELEGRAM_ALLOWED_USERS` 中的使用者傳送 `/start`

**預期結果：**
- 機器人回應「存取被拒」或類似訊息
- 機器人忽略此使用者的所有後續命令

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 2. 基本命令

### 測試 2.1：目錄導覽

**步驟：**
1. 傳送 `/pwd` - 顯示目前目錄
2. 傳送 `/ls` - 列出目前目錄
3. 傳送 `/cd /tmp` - 切換到 /tmp 目錄
4. 傳送 `/pwd` - 驗證目錄已變更

**預期結果：**
- `/pwd` 顯示目前工作目錄路徑
- `/ls` 顯示目錄內容，包含檔案/資料夾圖示
- `/cd` 成功變更目錄（如果路徑被允許）
- 工作目錄在命令之間持續存在

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 2.2：新對話

**步驟：**
1. 與機器人進行對話
2. 傳送 `/new` 命令
3. 參考前一個對話

**預期結果：**
- `/new` 清除對話歷史
- 機器人不記得前一個內容
- 顯示確認訊息

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 3. 檔案操作（讀取）

### 測試 3.1：讀取檔案

**步驟：**
1. 建立測試檔案：`echo "Hello World" > /tmp/test.txt`
2. 傳送給機器人：「請讀取 /tmp/test.txt 檔案」

**預期結果：**
- 機器人自動呼叫 `read_file` 工具（不需要確認）
- 機器人顯示檔案內容：「Hello World」
- 沒有顯示權限提示（讀取自動批准）

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 3.2：列出目錄

**步驟：**
1. 傳送給機器人：「請列出 /tmp 中的檔案」

**預期結果：**
- 機器人自動呼叫 `list_directory` 工具
- 機器人顯示檔案和資料夾名稱
- 顯示相對大小和類型

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 4. 檔案操作（寫入）

### 測試 4.1：寫入檔案

**步驟：**
1. 傳送給機器人：「請建立 /tmp/bot_test.txt 檔案，內容為『測試寫入』」
2. 點擊權限提示中的「允許」
3. 驗證檔案存在：`cat /tmp/bot_test.txt`

**預期結果：**
- 機器人顯示權限提示，包含檔案路徑和內容預覽
- 批准後，機器人執行 `write_file` 工具
- 檔案使用正確內容建立
- 機器人確認成功

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 4.2：拒絕寫入操作

**步驟：**
1. 傳送給機器人：「請建立 /tmp/denied.txt 檔案，內容為『測試』」
2. 點擊權限提示中的「拒絕」

**預期結果：**
- 機器人顯示權限提示
- 拒絕後，機器人不建立檔案
- 機器人回應「操作已取消」或類似訊息
- 檔案不存在

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 4.3：附加到檔案

**步驟：**
1. 建立初始檔案：`echo "Line 1" > /tmp/append_test.txt`
2. 傳送給機器人：「請附加『Line 2』到 /tmp/append_test.txt」
3. 批准操作
4. 驗證：`cat /tmp/append_test.txt`

**預期結果：**
- 機器人要求附加操作的權限
- 批准後，內容被附加（不是覆蓋）
- 檔案包含兩行

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 4.4：刪除檔案

**步驟：**
1. 建立測試檔案：`touch /tmp/delete_me.txt`
2. 傳送給機器人：「請刪除 /tmp/delete_me.txt」
3. 批准操作
4. 驗證：`ls /tmp/delete_me.txt`（應該不存在）

**預期結果：**
- 機器人顯示包含檔案路徑的權限提示
- 批准後，檔案被刪除
- 機器人確認刪除
- 檔案不再存在

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 4.5：建立目錄

**步驟：**
1. 傳送給機器人：「請建立 /tmp/test_dir 目錄」
2. 批准操作
3. 驗證：`ls -ld /tmp/test_dir`

**預期結果：**
- 機器人要求權限
- 批准後建立目錄
- 機器人確認成功

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 4.6：移動/重新命名檔案

**步驟：**
1. 建立檔案：`echo "Move me" > /tmp/source.txt`
2. 傳送給機器人：「請將 /tmp/source.txt 移動到 /tmp/destination.txt」
3. 批准操作
4. 驗證兩個路徑

**預期結果：**
- 機器人要求權限，顯示來源和目的地
- 來源檔案被移動/重新命名為目的地
- 來源不再存在，目的地有正確的內容

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 4.7：複製檔案

**步驟：**
1. 建立檔案：`echo "Copy me" > /tmp/original.txt`
2. 傳送給機器人：「請複製 /tmp/original.txt 到 /tmp/copy.txt」
3. 批准操作
4. 驗證兩個檔案都存在

**預期結果：**
- 機器人要求權限，顯示來源和目的地
- 操作後兩個檔案都存在
- 兩個檔案的內容相同

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 5. 瀏覽器自動化

### 測試 5.1：瀏覽 URL

**步驟：**
1. 傳送給機器人：「請瀏覽 https://example.com 並告訴我裡面寫什麼」

**預期結果：**
- 機器人自動呼叫 `browse_url` 工具（不需要確認）
- 機器人提取頁面標題和文字內容
- 機器人總結網頁內容
- 操作在逾時內完成（預設 30 秒）

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 5.2：網址螢幕截圖

**步驟：**
1. 傳送給機器人：「對 https://google.com 進行螢幕截圖」

**預期結果：**
- 機器人自動呼叫 `screenshot_url` 工具
- 機器人以 PNG 格式傳送螢幕截圖
- 圖片顯示實際的網頁
- 操作在逾時內完成

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 5.3：從網頁提取資料

**步驟：**
1. 傳送給機器人：「從 https://example.com 提取主標題」

**預期結果：**
- 機器人使用適當的 CSS 選擇器呼叫 `extract_data` 工具
- 機器人提取並返回標題文字
- 優雅處理遺失的元素

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 6. AI 圖片生成

### 測試 6.1：生成圖片

**步驟：**
1. 傳送給機器人：「生成一隻可愛的小貓玩毛線的圖片」
2. 點擊權限提示中的「允許」

**預期結果：**
- 機器人顯示權限提示（圖片生成會消耗 API 配額）
- 批准後，機器人呼叫 `generate_image` 工具
- 機器人傳送生成的圖片
- 圖片符合說明

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 6.2：圖片生成失敗處理

**步驟：**
1. 如果 Google Cloud 認證未配置，請嘗試生成圖片

**預期結果：**
- 機器人顯示適當的錯誤訊息
- 錯誤說明需要身份驗證
- 機器人建議檢查 GOOGLE_APPLICATION_CREDENTIALS

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 7. 文件分析

### 測試 7.1：分析 PDF 文件

**步驟：**
1. 建立或下載測試 PDF 檔案
2. 傳送給機器人：「請分析 /path/to/document.pdf」

**預期結果：**
- 機器人從 PDF 提取文字
- 機器人總結文件內容
- 正確處理多頁 PDF

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 7.2：分析 Word 文件

**步驟：**
1. 建立或下載測試 DOCX 檔案
2. 傳送給機器人：「請分析 /path/to/document.docx」

**預期結果：**
- 機器人從 DOCX 提取文字
- 機器人總結文件內容
- 保留基本格式資訊

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 8. 檔案組織

### 測試 8.1：按類型組織檔案

**步驟：**
1. 建立包含混合檔案的測試目錄：
   ```bash
   mkdir /tmp/test_organize
   touch /tmp/test_organize/{test1.txt,test2.txt,image.jpg,doc.pdf}
   ```
2. 傳送給機器人：「請按類型組織 /tmp/test_organize 中的檔案」
3. 批准操作

**預期結果：**
- 機器人建立子目錄（documents/、images/ 等）
- 檔案被移動到適當的子目錄
- 原始目錄結構已更新
- 機器人提供組織摘要

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 9. 網路搜尋

### 測試 9.1：搜尋並總結

**步驟：**
1. 傳送給機器人：「搜尋 TypeScript 的資訊並總結結果」

**預期結果：**
- 機器人執行網路搜尋（如果搜尋工具可用）
- 機器人總結搜尋結果
- 提供相關連結或引用

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 10. 安全性與路徑驗證

### 測試 10.1：已阻止的路徑存取

**步驟：**
1. 傳送給機器人：「讀取 ~/.ssh/id_rsa 檔案」

**預期結果：**
- 機器人拒絕存取敏感路徑
- 錯誤訊息解釋路徑不被允許
- 不顯示權限提示（硬性阻止）

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 10.2：路徑遍歷預防

**步驟：**
1. 傳送給機器人：「讀取 /allowed/path/../../etc/passwd 檔案」

**預期結果：**
- 機器人檢測路徑遍歷嘗試
- 存取被拒絕
- 顯示錯誤訊息

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 10.3：在允許路徑外

**步驟：**
1. 傳送給機器人：「列出 /root 中的檔案」

**預期結果：**
- 機器人檢查路徑是否在 ALLOWED_PATHS 中
- 如果不允許，操作被拒絕
- 錯誤訊息說明允許的路徑

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 11. 配額管理

### 測試 11.1：正常配額使用

**步驟：**
1. 檢查初始配額：傳送幾條訊息
2. 機器人應追蹤令牌使用

**預期結果：**
- 配額按使用者追蹤
- 最初沒有警告
- 每個請求的使用都會增加

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 11.2：配額警告

**步驟：**
1. 生成足夠的請求以達到配額的 80%
2. 繼續傳送訊息

**預期結果：**
- 達到 80% 閾值時，機器人顯示警告
- 警告包含目前使用和限制
- 機器人仍然處理請求

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 11.3：超過配額限制

**步驟：**
1. 繼續超過配額限制的請求

**預期結果：**
- 機器人拒絕新請求
- 錯誤訊息解釋配額已超出
- 訊息包含重設時間

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 12. MCP 整合

### 測試 12.1：MCP 伺服器連線

**步驟：**
1. 在配置中配置 MCP 伺服器
2. 重新啟動機器人
3. 傳送使用 MCP 工具的命令

**預期結果：**
- 機器人連接到 MCP 伺服器
- MCP 工具在工具註冊表中可用
- 工具正確執行

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 12.2：MCP 伺服器失敗

**步驟：**
1. 停止 MCP 伺服器或錯誤配置
2. 嘗試使用 MCP 工具

**預期結果：**
- 機器人偵測 MCP 伺服器不可用
- 錯誤訊息對使用者友善
- 機器人繼續使用其他工具

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 13. 對話與內容

### 測試 13.1：多輪對話

**步驟：**
1. 傳送：「建立一個叫 test.txt 的檔案，內容為『Hello』」
2. 批准並等待完成
3. 傳送：「現在讀取該檔案」

**預期結果：**
- 機器人記住第一條訊息的內容
- 機器人理解「該檔案」指的是 test.txt
- 操作成功完成

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 13.2：內容持續性

**步驟：**
1. 進行關於特定主題的對話
2. 機器人應在多條訊息中維護內容
3. 傳送 `/new` 清除內容
4. 參考前一個對話

**預期結果：**
- 機器人記住對話內容
- `/new` 後內容被清除
- 機器人不記得已清除的內容

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 14. 錯誤處理

### 測試 14.1：無效檔案路徑

**步驟：**
1. 傳送給機器人：「讀取 /nonexistent/path/file.txt 檔案」

**預期結果：**
- 機器人嘗試操作
- 返回清晰的錯誤訊息
- 錯誤說明找不到檔案

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 14.2：權限逾時

**步驟：**
1. 傳送寫入操作請求
2. 等待 30 秒而不回應權限提示

**預期結果：**
- 權限請求逾時
- 操作自動被拒絕
- 機器人傳送逾時訊息

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 14.3：網路錯誤

**步驟：**
1. 斷開網路連接
2. 嘗試瀏覽 URL 或生成圖片

**預期結果：**
- 機器人優雅地處理網路錯誤
- 錯誤訊息對使用者友善
- 機器人保持可操作

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 15. 效能與穩定性

### 測試 15.1：大檔案處理

**步驟：**
1. 建立大檔案：`dd if=/dev/zero of=/tmp/large.bin bs=1M count=10`
2. 傳送給機器人：「讀取 /tmp/large.bin 檔案」

**預期結果：**
- 機器人適當處理大檔案
- 如果檔案太大，返回錯誤或截斷
- 機器人保持回應

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 15.2：並行請求

**步驟：**
1. 快速傳送多條訊息（5-10 條訊息）
2. 所有應為不同的命令

**預期結果：**
- 機器人處理所有請求
- 回應可能排隊但全部完成
- 無崩潰或錯誤

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

### 測試 15.3：長時間執行操作

**步驟：**
1. 瀏覽載入緩慢的網站
2. 等待操作完成

**預期結果：**
- 機器人在處理時顯示輸入指示器
- 操作完成或優雅逾時
- 逾時時間與 BROWSER_TIMEOUT 設定相符

**狀態：** ⬜ 未測試 | ✅ 通過 | ❌ 失敗

## 疑難排解

### 常見問題

#### 機器人不回應
```bash
# 檢查機器人是否執行
./status.sh

# 檢查日誌中的錯誤
tail -50 bot.log

# 重新啟動機器人
./stop.sh && ./start.sh
```

#### 權限提示未顯示
- 檢查使用者 ID 是否在 TELEGRAM_ALLOWED_USERS 中
- 驗證操作需要權限（寫入，不是讀取）
- 檢查機器人日誌中的錯誤

#### 工具不工作
```bash
# 檢查環境變數
cat .env

# 驗證相依套件
bun install
npx playwright install chromium

# 檢查 TypeScript 編譯
bun run typecheck
```

#### 配額問題
- 檢查 .env 中的配額限制
- 等待配額重設（每小時/每天）
- 如需要，調整限制

## 測試摘要模板

日期：_______________
測試者：_______________

總測試數：44
通過：___ / 44
失敗：___ / 44
未測試：___ / 44

關鍵失敗：_______
備註：_______________________

## 持續測試

進行中的開發：
1. 在每次主要功能新增後執行這些測試
2. 在每次發行前執行測試子集
3. 為新功能新增新測試案例
4. 行為變更時更新測試案例

## 自動化測試

雖然本指南側重於手動測試，請考慮：
- 為核心函數編寫單位測試
- 為工具執行新增整合測試
- 使用 Playwright 建立端到端測試
- 為自動化測試設定 CI/CD 管線
